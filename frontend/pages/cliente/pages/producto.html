<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapStyle - Tu Centro Comercial Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./css/main.css">
</head>

<body class="bg-gray-50 flex flex-col min-h-screen">
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <a href="index.html" class="text-2xl font-extrabold text-indigo-600 tracking-wider">
                TapStyle
            </a>
            <nav class="space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600">Inicio</a>
                <a href="carrito.html" class="text-gray-600 hover:text-indigo-600">Carrito</a>
            </nav>
        </div>
    </header>
    <main class="flex-grow">
        <section class="py-12">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="p-6 bg-gradient-to-br from-blue-50 to-white flex items-center justify-center">
                            <img id="product-image" src="https://placehold.co/600x600/93C5FD/ffffff?text=Producto"
                                alt="producto" class="w-full max-w-md rounded-lg object-cover shadow-md" />
                        </div>

                        <div class="p-8">
                            <div class="flex items-center justify-between">
                                <h1 id="product-name" class="text-3xl font-extrabold text-sky-900">
                                    Producto Destacado
                                </h1>
                                <div class="text-right">
                                    <div id="product-store" class="text-sm text-sky-600 font-medium">
                                        Vendido por:
                                        <span class="font-semibold text-sky-800">Tienda Ejemplo</span>
                                    </div>
                                    <div id="product-price" class="text-2xl font-extrabold text-sky-800 mt-1">
                                        $120.00
                                    </div>
                                </div>
                            </div>

                            <p id="product-desc" class="mt-4 text-gray-600 leading-relaxed">
                                Descripción breve y llamativa del producto. Materiales, corte y estilo resumidos para
                                atraer al comprador.
                            </p>

                            <div class="mt-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Colores disponibles</h4>
                                <div id="product-colors-buttons" class="flex items-center space-x-3">
                                    <button
                                        class="w-8 h-8 rounded-full bg-sky-600 ring-2 ring-transparent hover:ring-sky-300"
                                        title="Azul" data-color="Azul"></button>
                                    <button
                                        class="w-8 h-8 rounded-full bg-gray-800 ring-2 ring-transparent hover:ring-sky-300"
                                        title="Negro" data-color="Negro"></button>
                                    <button
                                        class="w-8 h-8 rounded-full bg-pink-500 ring-2 ring-transparent hover:ring-sky-300"
                                        title="Rosa" data-color="Rosa"></button>
                                    <button
                                        class="w-8 h-8 rounded-full bg-yellow-400 ring-2 ring-transparent hover:ring-sky-300"
                                        title="Amarillo" data-color="Amarillo"></button>
                                </div>
                            </div>

                            <div id="product-sizes-container" class="mt-6" style="display: none;">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Tallas</h4>
                                <div id="product-sizes-buttons" class="flex items-center space-x-2">
                                    </div>
                            </div>


                            <div class="mt-6 flex items-center space-x-4">
                                <label class="text-sm text-gray-700">Cantidad</label>
                                <input id="product-qty" type="number" min="1" value="1"
                                    class="w-20 px-3 py-2 border rounded-md" />
                            </div>

                            <div class="mt-8 flex items-center space-x-4">
                                <button id="btn-add"
                                    class="px-5 py-3 bg-sky-700 text-white rounded-lg shadow hover:bg-sky-800 transition">
                                    Añadir al carrito
                                </button>
                                <a href="carrito.html"
                                    class="px-5 py-3 bg-white border border-sky-200 text-sky-700 rounded-lg hover:bg-sky-50 transition">
                                    Ver carrito
                                </a>
                                <a href="pago.html"
                                    class="ml-auto px-5 py-3 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition">
                                    Comprar ahora
                                </a>
                            </div>

                            <div
                                class="mt-8 text-base text-gray-600 leading-relaxed space-y-2 border-t border-gray-100 pt-4">
                                <p><strong class="font-semibold text-gray-800">Material:</strong> 100% algodón premium.
                                </p>
                                <p><strong class="font-semibold text-gray-800">Envío:</strong> Entrega en 3–5 días
                                    hábiles.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        (function () {
            const CART_KEY = "tapstyle_cart";
            
            // --- NUEVAS VARIABLES PARA GUARDAR LA SELECCIÓN ---
            let selectedSize = null;
            let hasSizes = false; // Para saber si debemos validar la talla
            let selectedColor = null;

            function qs(name) {
                const url = new URL(location.href);
                return url.searchParams.get(name);
            }
            function safeDecode(v) {
                try {
                    return decodeURIComponent(v);
                } catch (e) {
                    return v || "";
                }
            }

            // --- Lectura de Parámetros ---
            const name =
                safeDecode(qs("name")) ||
                document.getElementById("product-name").textContent.trim() ||
                "Producto por Defecto";
            
            const priceRaw = qs("price") || "0";
            const price =
                parseFloat(priceRaw.replace(/[^0-9.,]/g, "").replace(",", ".")) || 0.0;

            const image =
                qs("image") ||
                "https://placehold.co/600x600/93C5FD/ffffff?text=Producto";
            
            const store =
                safeDecode(qs("store")) ||
                (document.getElementById("product-store").querySelector("span") && document.getElementById("product-store").querySelector("span").textContent.trim()) ||
                "Tienda Desconocida";

            const desc =
                safeDecode(qs("desc")) ||
                document.getElementById("product-desc").textContent.trim() ||
                "Descripción no disponible.";

            const sizesStr = safeDecode(qs("sizes")); // "S,M,L" o ""

            
            // --- Actualizar el HTML ---
            document.getElementById("product-name").textContent = name;
            document.getElementById("product-price").textContent =
                "S/ " + Number(price).toFixed(2);
            document.getElementById("product-image").src = image;
            document.getElementById("product-store").innerHTML =
                'Vendido por: <span class="font-semibold text-sky-800">' +
                store +
                "</span>";
            document.getElementById("product-desc").textContent = desc;

            // Lógica para Tallas
            const tallasContainer = document.getElementById("product-sizes-container");
            const tallasButtonsContainer = document.getElementById("product-sizes-buttons");
            
            if (sizesStr) {
                hasSizes = true; // Marcamos que este producto requiere talla
                const sizes = sizesStr.split(',');
                
                tallasButtonsContainer.innerHTML = '';
                
                sizes.forEach(size => {
                    const button = document.createElement('button');
                    // Añadimos data-size para identificarlo
                    button.dataset.size = size; 
                    button.className = "px-3 py-1 border rounded-md text-sm text-gray-700 hover:bg-sky-50";
                    button.textContent = size;
                    tallasButtonsContainer.appendChild(button);
                });
                
                tallasContainer.style.display = 'block';
            } else {
                tallasContainer.style.display = 'none';
            }

            // --- Lógica del Carrito ---
            
            function showToast(msg) {
                let t = document.getElementById("toast");
                if (!t) {
                    t = document.createElement("div");
                    t.id = "toast";
                    t.className =
                        "fixed bottom-6 right-6 bg-slate-900 text-white px-4 py-2 rounded shadow-lg opacity-0 transform translate-y-4 transition-all";
                    document.body.appendChild(t);
                }
                t.textContent = msg;
                t.style.opacity = "1";
                t.style.transform = "translateY(0)";
                setTimeout(() => {
                    t.style.opacity = "0";
                    t.style.transform = "translateY(12px)";
                }, 1800);
            }

            function getCart() {
                try {
                    return JSON.parse(localStorage.getItem(CART_KEY) || "[]");
                } catch (e) {
                    return [];
                }
            }
            function saveCart(cart) {
                localStorage.setItem(CART_KEY, JSON.stringify(cart));
                updateCartCount();
            }
            function updateCartCount() {
                const el = document.getElementById("cart-count"); 
                if (!el) return;
                const cart = getCart();
                const count = cart.reduce((s, i) => s + (i.qty || 0), 0);
                el.textContent = count;
            }

            function addItem(item) {
                const cart = getCart();
                // Esta lógica ahora funciona por variación (ej: p1_S_Negro)
                const existing = cart.find((c) => c.id === item.id);
                if (existing) {
                    existing.qty = (existing.qty || 0) + (item.qty || 1);
                } else {
                    item.qty = item.qty || 1;
                    cart.push(item);
                }
                saveCart(cart);
                showToast("Producto añadido con éxito");
            }

            // --- EVENTOS DE CLIC (NUEVO) ---
            document.addEventListener("DOMContentLoaded", () => {
                
                // 1. Event Listener para Tallas (con delegación de eventos)
                tallasButtonsContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        selectedSize = e.target.dataset.size; // Guardamos la talla
                        
                        // Resaltar el botón seleccionado
                        Array.from(tallasButtonsContainer.children).forEach(btn => 
                            btn.classList.remove('ring-2', 'ring-sky-500', 'bg-sky-50')
                        );
                        e.target.classList.add('ring-2', 'ring-sky-500', 'bg-sky-50');
                    }
                });

                // 2. Event Listener para Colores (con delegación de eventos)
                const colorButtonsContainer = document.getElementById('product-colors-buttons');
                colorButtonsContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        selectedColor = e.target.dataset.color; // Guardamos el color
                        
                        // Resaltar el botón seleccionado
                        Array.from(colorButtonsContainer.children).forEach(btn => 
                            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-sky-500')
                        );
                        e.target.classList.add('ring-2', 'ring-offset-2', 'ring-sky-500');
                    }
                });

                // 3. Event Listener para el botón "Añadir al carrito" (MODIFICADO)
                const btn = document.getElementById("btn-add");
                if (btn) {
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        
                        // --- VALIDACIÓN ---
                        if (hasSizes && !selectedSize) {
                            showToast("Por favor, selecciona una talla.");
                            return; // Detenemos la función
                        }
                        if (!selectedColor) {
                            showToast("Por favor, selecciona un color.");
                            return; // Detenemos la función
                        }

                        const qtyEl = document.getElementById("product-qty");
                        const qty = Math.max(1, parseInt(qtyEl && qtyEl.value) || 1);
                        
                        const productName = name; 
                        const productPrice = price;
                        const productImage = image;
                        
                        // ID del producto base (ej: 'p1')
                        const productId = qs("id") || productName.replace(/\s+/g, "_").toLowerCase();
                        
                        // ID de la variación (ej: 'p1_S_Negro')
                        const variationId = `${productId}_${selectedSize || 'talla-unica'}_${selectedColor.replace(/\s+/g, '-')}`;

                        // Creamos el objeto completo para el carrito
                        addItem({ 
                            id: variationId,        // ID único de la variación
                            productId: productId,   // ID del producto general
                            name: productName, 
                            price: productPrice, 
                            image: productImage, 
                            qty: qty,
                            size: selectedSize,     // "S", "M", "L", etc.
                            color: selectedColor    // "Negro", "Azul", etc.
                        });

                        const original = btn.textContent;
                        btn.textContent = "Añadido";
                        setTimeout(() => (btn.textContent = original), 800);
                    });
                }
                updateCartCount();
            });
        })();
    </script>
    
    <!-- Footer se carga dinámicamente -->
    <div id="footer-container"></div>
    <script src="../../../components/footer/footer.js"></script>
</body>

</html>