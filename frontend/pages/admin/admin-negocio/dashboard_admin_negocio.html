<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">

        <!-- SIDEBAR -->
        <aside id="sidebar"
            class="w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white flex-shrink-0 shadow-2xl flex flex-col overflow-y-auto">

            <!-- LOGO -->
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-3xl font-extrabold text-blue-400 tracking-wider">TapStyle</h1>
                <p class="text-xs text-gray-400 mt-1">ADMIN NEGOCIO</p>
            </div>

            <!-- PERFIL DEL USUARIO -->
            <div class="flex flex-col items-center py-6 border-b border-gray-700 px-4">
                <div class="w-20 h-20 rounded-full bg-blue-600 flex items-center justify-center text-3xl font-bold shadow-lg"
                    data-empresa-initials>
                    SV
                </div>
                <h2 class="mt-3 text-lg font-semibold text-center" data-empresa-nombre>Tu Empresa</h2>
                <p class="text-sm text-gray-400 mt-1" data-usuario-nombre>Usuario</p>
            </div>

            <!-- NAVEGACI√ìN -->
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">

                <!-- Dashboard -->
                <a href="dashboard_admin_negocio.html"
                    class="flex items-center px-4 py-3 rounded-lg bg-blue-600 text-white shadow-md transition duration-150">
                    <i class="fas fa-chart-line mr-3 text-lg"></i>
                    <span class="font-medium">Dashboard</span>
                </a>

                <!-- CAT√ÅLOGO (Expandible) -->
                <div class="mt-4">
                    <button onclick="toggleMenu(this)"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <div class="flex items-center">
                            <i class="fas fa-box mr-3 text-lg"></i>
                            <span class="font-medium">Cat√°logo</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                    <div class="submenu hidden ml-8 space-y-2 mt-2">
                        <a href="pages/productos.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-cube mr-2"></i> Productos
                        </a>
                        <a href="pages/categorias.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-list mr-2"></i> Categor√≠as
                        </a>
                        <a href="pages/marcas.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-tag mr-2"></i> Marcas
                        </a>
                    </div>
                </div>

                <!-- MI TIENDA (NUEVO) -->
                <div class="mt-4">
                    <a href="#" onclick="irAMiTienda(event)"
                        class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-green-600 transition duration-150 bg-green-700 text-white">
                        <i class="fas fa-store mr-3 text-lg"></i>
                        <span class="font-medium">üõçÔ∏è Ir a Mi Tienda</span>
                    </a>
                </div>

                <!-- OPERACIONES (Expandible) -->
                <div class="mt-2">
                    <button onclick="toggleMenu(this)"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <div class="flex items-center">
                            <i class="fas fa-tasks mr-3 text-lg"></i>
                            <span class="font-medium">Operaciones</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                    <div class="submenu hidden ml-8 space-y-2 mt-2">
                        <a href="pages/compras.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-shopping-cart mr-2"></i> Compras
                        </a>
                        <a href="pages/ventas.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-cash-register mr-2"></i> Ventas
                        </a>
                        <a href="pages/stock.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-warehouse mr-2"></i> Stock
                        </a>
                        <a href="pages/proveedores.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-truck mr-2"></i> Proveedores
                        </a>
                        <a href="pages/metodos_pago.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-credit-card mr-2"></i> M√©todos de Pago
                        </a>
                    </div>
                </div>

                <!-- FINANZAS (Expandible) -->
                <div class="mt-2">
                    <button onclick="toggleMenu(this)"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <div class="flex items-center">
                            <i class="fas fa-money-bill-wave mr-3 text-lg"></i>
                            <span class="font-medium">Finanzas</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                    <div class="submenu hidden ml-8 space-y-2 mt-2">
                        <a href="pages/caja.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-cash-register mr-2"></i> Caja
                        </a>
                        <a href="pages/finanzas_pagos.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-chart-bar mr-2"></i> Finanzas
                        </a>
                    </div>
                </div>

                <!-- ADMINISTRACI√ìN (Expandible) -->
                <div class="mt-2">
                    <button onclick="toggleMenu(this)"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <div class="flex items-center">
                            <i class="fas fa-cog mr-3 text-lg"></i>
                            <span class="font-medium">Administraci√≥n</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                    <div class="submenu hidden ml-8 space-y-2 mt-2">
                        <a href="pages/clientes.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-users mr-2"></i> Clientes
                        </a>
                        <a href="pages/usuarios.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-user-cog mr-2"></i> Usuarios
                        </a>
                        <a href="pages/roles_permisos.html"
                            class="flex items-center px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition duration-150">
                            <i class="fas fa-shield-alt mr-2"></i> Roles y Permisos
                        </a>
                    </div>
                </div>

            </nav>

            <!-- CERRAR SESI√ìN -->
            <div class="p-4 border-t border-gray-700">
                <button onclick="cerrarSesionConfirm()"
                    class="w-full flex items-center justify-center px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition duration-150">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>

        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="flex-1 flex flex-col overflow-hidden">

            <!-- CABECERA -->
            <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <input type="text" placeholder="Buscar..."
                        class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-64">
                </div>
            </header>

            <!-- CONTENIDO -->
            <main class="flex-1 overflow-y-auto p-8">

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

                    <!-- KPI: Ventas del Mes -->
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Ventas del Mes</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="ventasDelMes">$0</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                                <i class="fas fa-shopping-cart text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">√öltimas 30 d√≠as</p>
                    </div>

                    <!-- KPI: Compras Pendientes -->
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-yellow-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Compras Pendientes</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="comprasPendientes">0</p>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full text-yellow-600">
                                <i class="fas fa-truck text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">√ìrdenes por recibir</p>
                    </div>

                    <!-- KPI: Stock Bajo -->
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-red-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Stock Bajo</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="stockBajo">0</p>
                            </div>
                            <div class="p-3 bg-red-100 rounded-full text-red-600">
                                <i class="fas fa-exclamation-triangle text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Productos por agotar</p>
                    </div>

                    <!-- KPI: Caja Disponible -->
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Caja Disponible</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="cajaDisponible">$0</p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-full text-green-600">
                                <i class="fas fa-wallet text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Saldo actual</p>
                    </div>

                </div>

                <!-- RESUMEN R√ÅPIDO -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- √öltimas Ventas -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">√öltimas Ventas</h2>
                        <div id="ultimasVentas" class="space-y-3">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>

                    <!-- Productos Top -->
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Top Productos</h2>
                        <div id="topProductos" class="space-y-3">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>

                </div>

            </main>

        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="../../../utils/permissions.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/api.js"></script>
    <script>

        // ============================================
        // FUNCIONES DE SIDEBAR
        // ============================================

        function toggleMenu(button) {
            const submenu = button.nextElementSibling;
            const icon = button.querySelector('i:last-child');

            submenu.classList.toggle('hidden');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }

        function cerrarSesionConfirm() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                cerrarSesion();
            }
        }

        // ============================================
        // IR A MI TIENDA
        // ============================================
        async function irAMiTienda(event) {
            event.preventDefault();
            const contexto = obtenerContexto();
            const tiendaId = contexto.idEmpresa;
            
            if (!tiendaId) {
                alert('Error: No se encontr√≥ la tienda');
                return;
            }
            
            // Guardar tiendaId en sessionStorage para que tienda-negocio lo pueda usar
            sessionStorage.setItem('tiendaId', tiendaId);
            
            // Redirigir a la tienda con par√°metro de URL
            window.location.href = `../../../tienda-negocio/tienda.html?tiendaId=${tiendaId}`;
        }

        // ============================================
        // CARGAR DATOS DEL DASHBOARD
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            // Validar autenticaci√≥n
            const auth = validarAutenticacion();
            if (!auth) return;

            console.log('üìä Cargando dashboard...');

            // Cargar datos desde API
            try {
                const contexto = obtenerContexto();
                const idEmpresa = contexto.idEmpresa;

                console.log('üîç Cargando estad√≠sticas para empresa:', idEmpresa);

                const response = await fetch(`http://localhost:8083/api/dashboard/stats/${idEmpresa}`);
                const data = await response.json();

                if (data.success && data.data) {
                    const stats = data.data;
                    console.log('‚úÖ Datos del dashboard cargados:', stats);
                    cargarDatos(stats);
                } else {
                    console.warn('‚ö†Ô∏è No se pudieron cargar los datos, usando placeholder');
                    cargarDatosPlaceholder();
                }
            } catch (error) {
                console.error('‚ùå Error al cargar dashboard:', error);
                console.warn('‚ö†Ô∏è Usando datos placeholder');
                cargarDatosPlaceholder();
            }
        });

        /**
         * Cargar datos reales desde el API
         */
        function cargarDatos(stats) {
            // KPIs
            document.getElementById('ventasDelMes').textContent = formatearMoneda(stats.ventasDelMes);
            document.getElementById('comprasPendientes').textContent = stats.comprasPendientes || 0;
            document.getElementById('stockBajo').textContent = stats.stockBajo || 0;
            document.getElementById('cajaDisponible').textContent = formatearMoneda(stats.cajaDisponible);

            // √öltimas Ventas
            if (stats.ultimasVentas && stats.ultimasVentas.length > 0) {
                document.getElementById('ultimasVentas').innerHTML = stats.ultimasVentas.map(venta => `
                    <div class="flex justify-between items-center py-2 border-b pb-2">
                        <div>
                            <p class="font-medium text-gray-800">${venta.numeroComprobante}</p>
                            <p class="text-sm text-gray-500">Cliente: ${venta.clienteNombre}</p>
                        </div>
                        <span class="text-green-600 font-semibold">${formatearMoneda(venta.monto)}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('ultimasVentas').innerHTML = '<p class="text-gray-500 text-sm">No hay ventas registradas</p>';
            }

            // Top Productos
            if (stats.topProductos && stats.topProductos.length > 0) {
                document.getElementById('topProductos').innerHTML = stats.topProductos.map(prod => `
                    <div class="flex justify-between items-center py-2 border-b pb-2">
                        <p class="text-sm text-gray-800">${prod.nombreProducto}</p>
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">${prod.cantidadVentas} ventas</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('topProductos').innerHTML = '<p class="text-gray-500 text-sm">No hay productos vendidos</p>';
            }
        }

        /**
         * Formatear n√∫mero como moneda
         */
        function formatearMoneda(valor) {
            if (!valor) return '$0.00';
            return new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN'
            }).format(valor);
        }

        // Datos placeholder mientras integramos con backend
        function cargarDatosPlaceholder() {
            document.getElementById('ventasDelMes').textContent = '$12,450';
            document.getElementById('comprasPendientes').textContent = '3';
            document.getElementById('stockBajo').textContent = '5';
            document.getElementById('cajaDisponible').textContent = '$8,920';

            document.getElementById('ultimasVentas').innerHTML = `
                <div class="flex justify-between items-center py-2 border-b pb-2">
                    <div>
                        <p class="font-medium text-gray-800">Pedido #001</p>
                        <p class="text-sm text-gray-500">Cliente: Juan P√©rez</p>
                    </div>
                    <span class="text-green-600 font-semibold">$450</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b pb-2">
                    <div>
                        <p class="font-medium text-gray-800">Pedido #002</p>
                        <p class="text-sm text-gray-500">Cliente: Mar√≠a Garc√≠a</p>
                    </div>
                    <span class="text-green-600 font-semibold">$320</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <div>
                        <p class="font-medium text-gray-800">Pedido #003</p>
                        <p class="text-sm text-gray-500">Cliente: Carlos L√≥pez</p>
                    </div>
                    <span class="text-green-600 font-semibold">$280</span>
                </div>
            `;

            document.getElementById('topProductos').innerHTML = `
                <div class="flex justify-between items-center py-2 border-b pb-2">
                    <p class="text-sm text-gray-800">Zapatilla XYZ</p>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">45 ventas</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b pb-2">
                    <p class="text-sm text-gray-800">Bot√≠n ABC</p>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">32 ventas</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <p class="text-sm text-gray-800">Sandalia DEF</p>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">28 ventas</span>
                </div>
            `;
        }

    </script>

</body>

</html>